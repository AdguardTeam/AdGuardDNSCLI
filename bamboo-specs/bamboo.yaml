---
# This comment is used to simplify checking local copies of the Makefile.  Bump
# this number every time a significant change is made to this Makefile.
#
# AdGuard-Project-Version: 8
'version': 2
'plan':
    'project-key': 'GO'
    'key': 'DNSCLIENT'
    'name': 'AdGuardDNSCLI'
'variables':
    # This variable is used to override Docker caching, for example to rerun a
    # flaky test suite.
    'cacheBuster': '0'
    # NOTE:  The Test stage depends on BusyBox syslogd on Alpine.
    'dockerGo': 'adguard/go-builder:1.25.7--1'
    'maintainer': 'Adguard Go Team'
    'name': 'adguarddns-cli'
    'channel': 'development'

'stages':
  - 'Test':
        'manual': false
        'final': false
        'jobs':
          - 'Test'
  - 'Artifact':
        'manual': false
        'final': false
        'jobs':
          - 'ArtifactQA'
          - 'Artifact'
  - 'Publish':
        'manual': false
        'final': false
        'jobs':
          - 'Publish'

'Test':
    'final-tasks':
      - 'test-parser':
          # The default pattern, '**/test-reports/*.xml', works, so don't set
          # the test-results property.
          'type': 'junit'
          'ignore-time': true
      - 'clean'
    'key': 'TEST'
    'tasks':
      - 'checkout':
            'force-clean-build': true
      - 'script':
            'interpreter': 'SHELL'
            'scripts':
              - |
                #!/bin/sh

                set -e -f -u -x

                docker info

                docker build \
                    --build-arg "BASE_IMAGE=${bamboo_dockerGo}" \
                    --build-arg "CACHE_BUSTER=${bamboo_cacheBuster}" \
                    --output '.' \
                    --progress 'plain' \
                    --target 'tester-exporter' \
                    -f ./docker/ci.Dockerfile \
                    .

                exit_code="$(cat ./test-reports/test-exit-code.txt)"
                readonly exit_code

                exit "$exit_code"

'Artifact':
    'artifacts':
      - 'name': 'AdGuardDNSCLI_darwin_amd64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_darwin_amd64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_darwin_arm64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_darwin_arm64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_linux_386'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_linux_386.tar.gz'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_linux_amd64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_linux_amd64.tar.gz'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_linux_arm64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_linux_arm64.tar.gz'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_386'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_386.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_386_msi'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_386.msi'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_amd64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_amd64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_amd64_msi'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_amd64.msi'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_arm64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_arm64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_arm64_msi'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_arm64.msi'
        'shared': true
        'required': true
      - 'name': 'Checksums'
        'pattern': '${bamboo.name}/dist/checksums.txt'
        'shared': true
        'required': true
      - 'name': 'Version'
        'pattern': '${bamboo.name}/dist/version.txt'
        'shared': true
        'required': true
    'key': 'ART'
    'other':
         'clean-working-dir': true
    'tasks':
      - 'checkout':
            'repository': 'bamboo-deploy-publisher'
            'path': 'bamboo-deploy-publisher'
            'force-clean-build': true
      - 'checkout':
            'path': '${bamboo.name}'
            'force-clean-build': true
      - 'script':
            'interpreter': 'SHELL'
            'scripts':
            - |
              #!/bin/sh

              set -e -f -u -x

              # Follow the working repository path.
              cd "${bamboo.name}"

              # Copy the deploy script to the working repository.
              cp ../bamboo-deploy-publisher/deploy.sh ./deploy.sh

              docker info

              docker build \
                  --build-arg "BASE_IMAGE=${bamboo_dockerGo}" \
                  --build-arg "BRANCH=${bamboo_planRepository_branchName}" \
                  --build-arg "CACHE_BUSTER=${bamboo_cacheBuster}" \
                  --build-arg "CHANNEL=${bamboo_channel}" \
                  --build-arg "DEPLOY_SCRIPT_PATH=./deploy.sh" \
                  --build-arg "GPG_SECRET_KEY=${bamboo_gpgSecretKeyPart1}${bamboo_gpgSecretKeyPart2}" \
                  --build-arg "GPG_KEY_PASSPHRASE=${bamboo_gpgPassword}" \
                  --build-arg "REVISION=${bamboo_repository_revision_number}" \
                  --build-arg "SIGNER_API_KEY=${bamboo_adguardDnsClientWinSignerSecretApiKey}" \
                  --build-arg "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" \
                  --build-arg "VERSION=${bamboo_buildNumber}" \
                  --output '.' \
                  --progress 'plain' \
                  --target 'builder-exporter' \
                  -f ./docker/ci.Dockerfile \
                  .

'ArtifactQA':
    'artifacts':
      - 'name': 'AdGuardDNSCLI_darwin_amd64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_darwin_amd64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_darwin_arm64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_darwin_arm64.zip'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_linux_amd64'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_linux_amd64.tar.gz'
        'shared': true
        'required': true
      - 'name': 'AdGuardDNSCLI_windows_amd64_msi'
        'pattern': '${bamboo.name}/dist/AdGuardDNSCLI_windows_amd64.msi'
        'shared': true
        'required': true
      - 'name': 'Checksums'
        'pattern': '${bamboo.name}/dist/checksums.txt'
        'shared': true
        'required': true
    'key': 'ARTQA'
    'other':
         'clean-working-dir': true
    'tasks':
      - 'checkout':
            'repository': 'bamboo-deploy-publisher'
            'path': 'bamboo-deploy-publisher'
            'force-clean-build': true
      - 'checkout':
            'path': '${bamboo.name}'
            'force-clean-build': true
      - 'script':
            'interpreter': 'SHELL'
            'scripts':
            - |
              #!/bin/sh

              set -e -f -u -x

              # Follow the working repository path.
              cd "${bamboo.name}"

              # Copy the deploy script to the working repository.
              cp ../bamboo-deploy-publisher/deploy.sh ./deploy.sh

              docker info

              docker build \
                  --build-arg "BASE_IMAGE=${bamboo_dockerGo}" \
                  --build-arg "BRANCH=${bamboo_planRepository_branchName}" \
                  --build-arg "CACHE_BUSTER=${bamboo_cacheBuster}" \
                  --build-arg "CHANNEL=${bamboo_channel}" \
                  --build-arg "DEPLOY_SCRIPT_PATH=./deploy.sh" \
                  --build-arg "GPG_SECRET_KEY=${bamboo_gpgSecretKeyPart1}${bamboo_gpgSecretKeyPart2}" \
                  --build-arg "GPG_KEY_PASSPHRASE=${bamboo_gpgPassword}" \
                  --build-arg "REVISION=${bamboo_repository_revision_number}" \
                  --build-arg "SIGNER_API_KEY=${bamboo_adguardDnsClientWinSignerSecretApiKey}" \
                  --build-arg "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" \
                  --build-arg "VERSION=${bamboo_buildNumber}" \
                  --output '.' \
                  --progress 'plain' \
                  --target 'qa-builder-exporter' \
                  -f ./docker/ci.Dockerfile \
                  .

'Publish':
    'artifact-subscriptions':
    - 'artifact': 'AdGuardDNSCLI_darwin_amd64'
    - 'artifact': 'AdGuardDNSCLI_darwin_arm64'
    - 'artifact': 'AdGuardDNSCLI_linux_386'
    - 'artifact': 'AdGuardDNSCLI_linux_amd64'
    - 'artifact': 'AdGuardDNSCLI_linux_arm64'
    - 'artifact': 'AdGuardDNSCLI_windows_386'
    - 'artifact': 'AdGuardDNSCLI_windows_386_msi'
    - 'artifact': 'AdGuardDNSCLI_windows_amd64'
    - 'artifact': 'AdGuardDNSCLI_windows_amd64_msi'
    - 'artifact': 'AdGuardDNSCLI_windows_arm64'
    - 'artifact': 'AdGuardDNSCLI_windows_arm64_msi'
    - 'artifact': 'Checksums'
    - 'artifact': 'Version'
    'final-tasks':
    - 'clean'
    'key': 'PGH'
    'other':
        'clean-working-dir': true
    'tasks':
    - 'clean'
    - 'checkout':
          'repository': 'bamboo-deploy-publisher'
          'path': 'bamboo-deploy-publisher'
          'force-clean-build': true
    - 'script':
            'interpreter': 'SHELL'
            'scripts':
              - |
                #!/bin/sh

                set -e -f -u -x

                cd "${bamboo.name}/dist/"

                env\
                    GITHUB_TOKEN="${bamboo.githubPublicRepoPassword}"\
                    ../../bamboo-deploy-publisher/deploy.sh\
                    adguarddns-cli-github

# TODO(e.burkov):  Limit repositories when the Bamboo version will support such
# configuration for triggers via YAML specs.
#
# See https://docs.atlassian.com/bamboo-specs-docs/8.2.0/specs.html?yaml#triggering-selected-repositories.
'branches':
    'create': 'for-pull-request'
    'delete':
        'after-deleted-days': 1
        'after-inactive-days': 5
    'link-to-jira': true

'branch-overrides':
# rc-vX.Y.Z branches are the release candidate branches. They are created from
# the release branch and are used to build the release candidate images.  The
# "candidate" pseudo-channel is used to generate version.
  - '^rc-v[0-9]+\.[0-9]+\.[0-9]+':
        'variables':
            'dockerGo': 'adguard/go-builder:1.25.7--1'
            'channel': 'candidate'
        'stages':
        - 'Test':
            'manual': false
            'final': false
            'jobs':
            - 'Test'
        - 'Artifact':
            'manual': false
            'final': false
            'jobs':
            - 'ArtifactQA'
# release-vX.Y.Z branches are the branches from which the actual final release
# is built.
  - '^release-v[0-9]+\.[0-9]+\.[0-9]+':
        # Build final releases on release branches manually.
        'triggers': []
        # Set the default release channel on the final branch to release, as
        # these are the ones that actually get released.
        'variables':
            'dockerGo': 'adguard/go-builder:1.25.7--1'
            'channel': 'release'
        'stages':
        - 'Test':
            'manual': false
            'final': false
            'jobs':
            - 'Test'
        - 'Artifact':
            'manual': false
            'final': false
            'jobs':
            - 'Artifact'
        - 'Publish':
            'manual': false
            'final': false
            'jobs':
            - 'Publish'
# All the other branches, including master.
  - '^.*':
        'stages':
        - 'Test':
            'manual': false
            'final': false
            'jobs':
            - 'Test'
        - 'Artifact':
            'manual': false
            'final': false
            'jobs':
            - 'ArtifactQA'
        # Don't publish artifacts for other branches.

'notifications':
  - 'events':
      - 'plan-status-changed'
    'recipients':
      - 'webhook':
            'name': 'Build webhook'
            'url': 'http://prod.jirahub.service.eu.consul/v1/webhook/bamboo?channel=adguard-qa-dns-builds'

'labels': []

'other':
    'concurrent-build-plugin': 'system-default'
